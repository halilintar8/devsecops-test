name: "DevSecOps CI/CD üîí"

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-scan-deploy:
    runs-on: ubuntu-22.04

    permissions:
      contents: read
      security-events: write
      id-token: write
      pull-requests: write

    steps:
      # =====================================================
      # 1Ô∏è‚É£ Checkout repository
      # =====================================================
      - name: "Checkout repository"
        uses: actions/checkout@v4

      # =====================================================
      # 2Ô∏è‚É£ Set up Docker Buildx
      # =====================================================
      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      # =====================================================
      # 3Ô∏è‚É£ Load Infisical secrets
      # =====================================================
      - name: "Load Infisical secrets"
        uses: Infisical/secrets-action@v1.0.15
        with:
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          project-slug: devsecops-test-hi9-l
          env-slug: dev

      # =====================================================
      # 4Ô∏è‚É£ Verify injected secrets
      # =====================================================
      - name: "Verify injected secrets"
        run: |
          echo "üîë Checking if Infisical secrets are available..."
          echo "DATABASE_URL: ${DATABASE_URL:-Not Found}"
          echo "NODE_ENV: ${NODE_ENV:-Not Found}"

      # =====================================================
      # 5Ô∏è‚É£ Build Docker image
      # =====================================================
      - name: "Build API Docker image"
        run: |
          IMAGE_TAG=devsecops-test-api:latest
          echo "üèóÔ∏è Building Docker image $IMAGE_TAG..."
          docker build -t $IMAGE_TAG ./apps/api

      # =====================================================
      # 6Ô∏è‚É£ Install Trivy vulnerability scanner
      # =====================================================
      - name: "Install Trivy"
        run: |
          echo "‚¨áÔ∏è Installing Trivy..."
          TRIVY_VERSION=0.67.1
          curl -sfL "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz" -o trivy.tar.gz
          tar zxvf trivy.tar.gz
          sudo mv trivy /usr/local/bin/
          trivy --version

      # =====================================================
      # 7Ô∏è‚É£ Cache Trivy vulnerability database
      # =====================================================
      - name: "Cache Trivy DB"
        uses: actions/cache@v3
        with:
          path: ~/.trivycache
          key: trivy-db-${{ runner.os }}-${{ hashFiles('**/Dockerfile') }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      # =====================================================
      # 8Ô∏è‚É£ Run Trivy vulnerability scan
      # =====================================================
      - name: "Run Trivy vulnerability scan"
        run: |
          IMAGE_TAG=devsecops-test-api:latest
          mkdir -p $HOME/.trivycache
          trivy image \
            --cache-dir $HOME/.trivycache \
            --scanners vuln \
            --format json \
            --output trivy-report.json \
            --ignore-unfixed \
            --pkg-types os,library \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --ignorefile security/trivy/.trivyignore \
            $IMAGE_TAG

      # =====================================================
      # 9Ô∏è‚É£ Fail if HIGH/CRITICAL vulnerabilities found
      # =====================================================
      - name: "Fail on HIGH/CRITICAL vulnerabilities"
        run: |
          HIGH_COUNT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' trivy-report.json)
          echo "üîé High/Critical vulnerabilities found: $HIGH_COUNT"
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "‚ùå Failing workflow due to HIGH/CRITICAL vulnerabilities."
            exit 1
          else
            echo "‚úÖ No HIGH/CRITICAL vulnerabilities found."
          fi

      # =====================================================
      # üîü Upload Trivy scan report (always)
      # =====================================================
      - name: "Upload Trivy report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json

      # =====================================================
      # 1Ô∏è‚É£1Ô∏è‚É£ Deploy placeholder (safe default)
      # =====================================================
      - name: "Deploy placeholder"
        run: echo "üöÄ Deployment skipped: Azure credentials not set yet."
