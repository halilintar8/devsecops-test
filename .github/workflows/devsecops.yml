name: DevSecOps CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      # ---- Checkout repository ----
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---- Set up Docker ----
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---- Build API Docker image ----
      - name: Build API image
        run: |
          docker build -t devsecops-test-api:latest ./apps/api

      # ---- Run Trivy vulnerability scan ----
      - name: Run Trivy scan
        run: |
          trivy image \
            --format json \
            --output trivy-report.json \
            --ignore-unfixed \
            --vuln-type os,library \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --ignorefile security/trivy/.trivyignore \
            devsecops-test-api:latest

      # ---- Fail workflow on HIGH/CRITICAL vulnerabilities ----
      - name: Fail on HIGH/CRITICAL vulnerabilities
        run: |
          HIGH_COUNT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' trivy-report.json)
          echo "High/Critical vulnerabilities found: $HIGH_COUNT"
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "Failing workflow due to HIGH/CRITICAL vulnerabilities."
            exit 1
          fi

      # ---- Upload Trivy report as artifact ----
      - name: Upload Trivy report
        uses: actions/upload-artifact@v3
        with:
          name: trivy-report
          path: trivy-report.json

      # ---- (Optional) Deploy placeholder ----
      - name: Deploy to Minikube (placeholder)
        run: echo "Deployment steps will be added later."
